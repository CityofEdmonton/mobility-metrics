<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SharedStreets Micromobility</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js"></script>
    <script src="bundle.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@7.0.1/dist/simple-statistics.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.css"
    />
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #controls {
        padding-right: 80%;
        margin-left: 10px;
        heigh: 100%;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        margin-left: 20%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <h1 class="title" id="title"></h1>
      <div>
        <label>week</label>
        <input id="week" type="date" />
      </div>
      <div>
        <label>hour</label>
        <input id="period" type="range" min="0" max="167" value="31" step="1" />
      </div>
    </div>
    <div id="map"></div>
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoibW9yZ2FuaGVybG9ja2VyIiwiYSI6Ii1zLU4xOWMifQ.FubD68OEerk74AYCLduMZQ";
      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/dark-v9",
        center: [-83.06900024414062, 42.348395259793],
        zoom: 12
      });

      map.on("load", function() {
        map.addLayer({
          id: "bins",
          type: "fill",
          source: {
            type: "geojson",
            data: {
              type: "FeatureCollection",
              features: []
            }
          },
          layout: {},
          paint: {
            "fill-color": [
              "interpolate",
              ["linear"],
              ["get", "quantile"],
              1,
              "#f1eef6",
              2,
              "#d7b5d8",
              3,
              "#df65b0",
              4,
              "#dd1c77",
              5,
              "#980043"
            ],
            "fill-opacity": 0.4
          }
        });

        //:metric/:week/:period
        var metric = "h3_availability";
        var week = "2019-02-24";
        var period = "31";
        var periods = 168; // hours in week

        $("#week").on("change", function(data) {
          week = data.target.value.split("/").join("-");
          update();
        });
        $("#period").on("change", function(data) {
          period = data.target.value;
          update();
        });

        update();

        function update() {
          var days = {
            0: "Sun",
            1: "Mon",
            2: "Tue",
            3: "Wed",
            4: "Thu",
            5: "Fri",
            6: "Sat"
          };
          var day = days[Math.floor(((+period + 1) / 168) * 7)];
          var hour = (+period + 1) % 24;
          $("#title").text(day + " " + hour + ":00");

          $.getJSON("/metric/" + metric + "/" + week + "/" + period, function(
            data
          ) {
            var stats = data.features.map(f => {
              return f.properties.averageFractionalCount;
            });

            var groups = 5;

            data.features = data.features.map(f => {
              var quantile = ss.quantileRank(
                stats,
                f.properties.averageFractionalCount
              );
              f.properties.quantile = Math.floor(quantile * 5) + 1;
              delete f.properties.averageFractionalCount;

              return f;
            });

            map.getSource("bins").setData(data);
          });
        }
      });
    </script>
  </body>
</html>

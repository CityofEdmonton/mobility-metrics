<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SharedStreets Micromobility</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://unpkg.com/simple-statistics@7.0.1/dist/simple-statistics.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.css"
    />
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding-left: 25%;
        padding-right: 25%;
        padding-top: 10px;
      }
      .logo {
        height: 45px;
        margin: -12px;
        padding-right: 10px;
      }
      .daily-summary {
        background-color: #f7f7f7;
        padding: 15px;
        margin-left: -50px;
        margin-right: -50px;
      }
      .map {
        height: 350px;
        background-color: #f7f7f7;
      }
      .map-box {
        position: relative;
        top: 0;
        bottom: 0;
        width: 100%;
        height: 350px;
      }
      .timecheck {
        margin-right: 10px;
      }
      .export {
        margin-right: 25px;
        margin-top: auto;
      }
      #export-all {
        padding-top: 30px;
        padding-bottom: 150px;
      }
      #date {
        font-size: 20px;
        margin-left: 10px;
      }
      #provider {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <h1 class="title is-3">
      <img class="logo" src="shst-logo.jpg" />SharedStreets Mobility Metrics
    </h1>
    <div class="daily-summary">
      <h2 class="subtitle is-4">Daily Summary</h2>
      <nav class="level">
        <div class="level-item has-text-centered">
          <h3 class="subtitle is-4">Date:</h3>
          <input id="date" type="date" class="re-query" value="2018-11-09" />
        </div>
        <div class="level-item has-text-centered">
          <h3 class="subtitle is-4">Provider:</h3>
          <div class="select">
            <select id="provider" class="re-query">
              <option>Bird</option>
              <option>Lime</option>
              <option>Jump</option>
              <option>Scoot</option>
              <option>Spin</option>
            </select>
          </div>
        </div>
      </nav>
      <nav class="level">
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Total Vehicles</p>
            <p id="totalVehicles" class="title">?</p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Active Vehicles</p>
            <p id="totalActiveVehicles" class="title">?</p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Total Trips</p>
            <p id="totalTrips" class="title">?</p>
          </div>
        </div>
      </nav>
      <nav class="level">
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Total Distance</p>
            <p id="totalDistance" class="title">?</p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Avg Distance Per Vehicle</p>
            <p id="avgDistancePerVehicle" class="title">?</p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Avg Vehicle Utilization</p>
            <p id="avgVehicleUtilization" class="title">?</p>
          </div>
        </div>
      </nav>
      <nav class="level">
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Avg Trips Per Vehicle</p>
            <p id="avgTripsPerVehicle" class="title">?</p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Avg Trip Distance</p>
            <p id="avgTripDistance" class="title">?</p>
          </div>
        </div>
        <div class="level-item has-text-centered">
          <div>
            <p class="heading">Avg Trip Duration</p>
            <p id="avgTripDuration" class="title">?</p>
          </div>
        </div>
      </nav>
    </div>
    <hr />

    <h2 class="subtitle is-6">Time Filter</h2>
    <nav class="level">
      <div class="level-item has-text-centered">
        <div>
          <p class="heading">
            <input
              id="hour-checkbox"
              class="timecheck re-render"
              type="checkbox"
            />Hour
          </p>
          <input
            id="hour-slider"
            class="slider is-fullwidth re-render"
            step="1"
            min="0"
            max="24"
            value="12"
            type="range"
          />
          <p id="hour-value">12</p>
        </div>
      </div>
      <div class="level-item has-text-centered">
        <div>
          <p class="heading">
            <input
              id="minute-checkbox"
              class="timecheck re-render"
              type="checkbox"
            />Minute
          </p>
          <input
            id="minute-slider"
            class="slider is-fullwidth re-render"
            step="15"
            min="0"
            max="45"
            value="0"
            type="range"
          />
          <p id="minute-value">00</p>
        </div>
      </div>
    </nav>
    <hr />

    <h2 class="subtitle is-4">Activity</h2>
    <div class="tile">
      <div class="tile is-vertical is-4">
        <div class="control">
          <label class="radio">
            <input
              id="activity-streets"
              class="re-render"
              type="radio"
              name="activity-radio"
              checked
            />
            Streets
          </label>
          <label class="radio">
            <input
              id="activity-bins"
              class="re-render"
              type="radio"
              name="activity-radio"
            />
            Bins
          </label>
        </div>
        <a id="activity-export" class="button is-link export">Export</a>
      </div>
      <div class="tile is-vertical is-8 map">
        <div id="activity-map" class="map-box"></div>
      </div>
    </div>

    <hr />

    <h2 class="subtitle is-4">Availability</h2>
    <div class="tile">
      <div class="tile is-vertical is-4">
        <div class="control">
          <label class="radio">
            <input
              id="availability-points"
              class="re-render"
              type="radio"
              name="availability-radio"
              checked
            />
            Points
          </label>
          <label class="radio">
            <input
              id="availability-bins"
              class="re-render"
              type="radio"
              name="availability-radio"
            />
            Bins
          </label>
        </div>
        <a id="availability-export" class="button is-link export">Export</a>
      </div>
      <div class="tile is-vertical is-8 map">
        <div id="availability-map" class="map-box"></div>
      </div>
    </div>

    <hr />

    <h2 class="subtitle is-4">On Street</h2>
    <div class="tile">
      <div class="tile is-vertical is-4">
        <div class="control">
          <label class="radio">
            <input
              id="onstreet-points"
              class="re-render"
              type="radio"
              name="onstreet-radio"
              checked
            />
            Points
          </label>
          <label class="radio">
            <input
              id="onstreet-bins"
              class="re-render"
              type="radio"
              name="onstreet-radio"
            />
            Bins
          </label>
        </div>
        <a id="onstreet-export" class="button is-link export">Export</a>
      </div>
      <div class="tile is-vertical is-8 map">
        <div id="onstreet-map" class="map-box"></div>
      </div>
    </div>

    <hr />

    <h2 class="subtitle is-4">Pick Ups</h2>
    <div class="tile">
      <div class="tile is-vertical is-4">
        <div class="control">
          <label class="radio">
            <input
              id="pickups-points"
              class="re-render"
              type="radio"
              name="pickups-radio"
              checked
            />
            Points
          </label>
          <label class="radio">
            <input
              id="pickups-bins"
              class="re-render"
              type="radio"
              name="pickups-radio"
            />
            Bins
          </label>
        </div>
        <a id="pickups-export" class="button is-link export">Export</a>
      </div>
      <div class="tile is-vertical is-8 map">
        <div id="pickups-map" class="map-box"></div>
      </div>
    </div>

    <hr />

    <h2 class="subtitle is-4">Drop Offs</h2>
    <div class="tile">
      <div class="tile is-vertical is-4">
        <div class="control">
          <label class="radio">
            <input
              id="dropoffs-points"
              class="re-render"
              type="radio"
              name="dropoffs-radio"
              checked
            />
            Points
          </label>
          <label class="radio">
            <input
              id="dropoffs-bins"
              class="re-render"
              type="radio"
              name="dropoffs-radio"
            />
            Bins
          </label>
        </div>
        <a id="dropoffs-export" class="button is-link export">Export</a>
      </div>
      <div class="tile is-vertical is-8 map">
        <div id="dropoffs-map" class="map-box"></div>
      </div>
    </div>

    <hr />

    <h2 class="subtitle is-4">Flows</h2>
    <div class="tile">
      <div class="tile is-vertical is-4">
        <a id="flows-export" class="button is-link export">Export</a>
      </div>
      <div class="tile is-vertical is-8 map">
        <div id="flows-map" class="map-box"></div>
      </div>
    </div>

    <hr />

    <div id="export-all" class="tile">
      <div class="tile is-vertical is-4">
        <a class="button is-success is-medium export">Export All</a>
      </div>
    </div>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoibW9yZ2FuaGVybG9ja2VyIiwiYSI6Ii1zLU4xOWMifQ.FubD68OEerk74AYCLduMZQ";

      var data;

      var maps = {
        "activity-map": null,
        "availability-map": null,
        "onstreet-map": null,
        "pickups-map": null,
        "dropoffs-map": null,
        "flows-map": null
      };
      $(() => {
        Object.keys(maps).forEach(map => {
          maps[map] = new mapboxgl.Map({
            container: map,
            style: "mapbox://styles/mapbox/light-v9",
            center: [-83.06900024414062, 42.348395259793],
            zoom: 12
          });
        });

        $(".re-query").on("change", () => {
          query();
        });

        $(".re-render").on("change", () => {
          render();
        });

        $("#hour-slider").on("change", () => {
          $("#hour-value").text($("#hour-slider").val());
        });

        $("#minute-slider").on("change", () => {
          $("#minute-value").text($("#minute-slider").val());
        });

        setTimeout(() => {
          query();
        }, 1000);
      });

      function query() {
        var date = $("#date").val();
        var provider = $("#provider option:selected")
          .val()
          .toLowerCase();
        var url = "/" + date + "/" + provider;
        console.log(url);

        /*$.getJSON(url, function(result) {
          console.log(result)
          data = result
          render()
        })*/

        fetch(url)
          .then(response => {
            return response.json();
          })
          .then(function(json) {
            data = json;
            render();
          })
          .catch(err => {
            data = undefined;
            render();
          });
      }

      function render() {
        if (!data) {
          $("#totalVehicles").text("?");
          $("#totalActiveVehicles").text("?");
          $("#totalTrips").text("?");
          $("#totalDistance").text("?");
          $("#avgDistancePerVehicle").text("?");
          $("#avgTripsPerVehicle").text("?");
          $("#avgTripDistance").text("?");
          $("#avgTripDuration").text("?");
        } else {
          $("#totalVehicles").text(data.totalVehicles);
          $("#totalActiveVehicles").text(data.totalActiveVehicles);
          $("#totalTrips").text(data.totalTrips);
          $("#totalDistance").text(Math.round(data.totalDistance) + " mi");
          $("#avgDistancePerVehicle").text(
            data.averageVehicleDistance.toFixed(2) + " mi"
          );
          $("#avgTripsPerVehicle").text(data.averageTrips.toFixed(2));
          $("#avgTripDistance").text(
            data.averageTripDistance.toFixed(2) + " mi"
          );
          $("#avgTripDuration").text(
            Math.floor(data.averageTripDuration) +
              "m " +
              Math.round(
                (data.averageTripDuration -
                  Math.floor(data.averageTripDuration)) *
                  60
              ) +
              "s"
          );
        }
      }
    </script>
  </body>
</html>
